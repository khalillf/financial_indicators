<!-- situation.component.html -->
<div class="p-6 bg-gray-900 min-h-screen text-white">
  <div class="max-w-7xl mx-auto space-y-8">
    <!-- ───────── Header ───────── -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-6">
      <h1 class="text-2xl font-bold text-white mb-6">
        Portfolio Transparency Analysis
      </h1>

      <!-- Inputs -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- PTF -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">PTF</label>
          <input
            [(ngModel)]="ptf"
            placeholder="Enter PTF"
            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-lg
                   focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
          />
        </div>

        <!-- Start date -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">
            Start Date <span class="text-blue-400">({{ dateImage | date:'dd-MM-yyyy' }})</span>
          </label>
          <input
            [(ngModel)]="dateImage"
            type="date"
            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-lg
                   focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
          />
        </div>

        <!-- End date -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">
            End Date <span class="text-blue-400">({{ dateImageFin | date:'dd-MM-yyyy' }})</span>
          </label>
          <input
            [(ngModel)]="dateImageFin"
            type="date"
            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-lg
                   focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
          />
        </div>
      </div>

      <!-- Action buttons -->
      <div class="flex flex-wrap gap-4">
        <!-- Transparisation link -->
        <a
          [href]="'/transparisation?date=' + selectedDate + '&ptf=' + ptf"
          target="_blank"
          class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg shadow-md
                 hover:shadow-lg transition-all flex items-center gap-2"
        >
          <i class="fa-solid fa-arrow-up-right-from-square"></i>
          Transparisation
        </a>

        <!-- Fetch data -->
        <button
          (click)="fetchData()"
          class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg shadow-md
                 hover:shadow-lg transition-all flex items-center gap-2"
        >
          <i class="fa-solid fa-database"></i>
          Calculate Pre‑Treatment
        </button>

        <!-- Transparise data -->
        <button
          (click)="transpariseData()"
          class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg shadow-md
                 hover:shadow-lg transition-all flex items-center gap-2"
        >
          <i class="fa-solid fa-arrows-spin"></i>
          Transparise
        </button>

        <!-- Save -->
        <button
          (click)="saveAllTableData()"
          class="px-6 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg shadow-md
                 hover:shadow-lg transition-all flex items-center gap-2"
        >
          <i class="fa-solid fa-floppy-disk"></i>
          Save Data
        </button>

        <!-- Go to graph -->
        <button
          (click)="goToGraphRatio()"
          class="px-6 py-3 bg-gradient-to-r from-teal-600 to-teal-700 text-white rounded-lg shadow-md
                 hover:shadow-lg transition-all flex items-center gap-2"
        >
          <i class="fa-solid fa-chart-column"></i>
          Regulatory Ratio Graph
        </button>
      </div>
    </div>

    <!-- ───────── Detail table ───────── -->
    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
      <div class="p-4 border-b border-gray-700">
        <h2 class="text-lg font-semibold text-white">Detailed Analysis</h2>
        <p class="text-sm text-gray-400">Individual item breakdown with transparency status</p>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm divide-y divide-gray-700">
          <thead class="bg-gray-700 text-gray-300">
          <tr>
            <th class="px-6 py-3 text-left uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left uppercase tracking-wider">Class</th>
            <th class="px-6 py-3 text-left uppercase tracking-wider">Category</th>
            <th class="px-6 py-3 text-center uppercase tracking-wider" colspan="2">Before Treatment</th>
            <th class="px-6 py-3 text-center uppercase tracking-wider" colspan="2">After Treatment</th>
          </tr>
          <tr class="bg-gray-600">
            <th colspan="3"></th>
            <th class="px-6 py-2">VC</th>
            <th class="px-6 py-2">VM</th>
            <th class="px-6 py-2">VC</th>
            <th class="px-6 py-2">VM</th>
          </tr>
          </thead>

          <tbody class="divide-y divide-gray-700">
          <tr
            *ngFor="let row of itemRows"
            [ngClass]="{ 'bg-purple-900': row.isTransparise, 'hover:bg-gray-700': true }"
          >
            <td class="px-6 py-4">{{ row.date }}</td>
            <td class="px-6 py-4">Class {{ row.classe }}</td>
            <td class="px-6 py-4">{{ row.categorieTitre }}</td>
            <td class="px-6 py-4 text-right">{{ row.vc | number:'1.2-2' }}</td>
            <td class="px-6 py-4 text-right">{{ row.vm | number:'1.2-2' }}</td>
            <td class="px-6 py-4 text-right">{{ row.apresVc | number:'1.2-2' }}</td>
            <td class="px-6 py-4 text-right">{{ row.apresVm | number:'1.2-2' }}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ───────── Summary table ───────── -->
    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
      <div class="p-4 border-b border-gray-700">
        <h2 class="text-lg font-semibold text-white">Summary & Ratios</h2>
        <p class="text-sm text-gray-400">Aggregated totals and regulatory ratios</p>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm divide-y divide-gray-700">
          <thead class="bg-gray-700 text-gray-300">
          <tr>
            <th class="px-6 py-3 text-left uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left uppercase tracking-wider">Class</th>
            <th class="px-6 py-3 text-left uppercase tracking-wider">Category</th>
            <th class="px-6 py-3 text-center uppercase tracking-wider" colspan="2">Before Treatment</th>
            <th class="px-6 py-3 text-center uppercase tracking-wider" colspan="2">After Treatment</th>
          </tr>
          <tr class="bg-gray-600">
            <th colspan="3"></th>
            <th class="px-6 py-2">VC</th>
            <th class="px-6 py-2">VM</th>
            <th class="px-6 py-2">VC</th>
            <th class="px-6 py-2">VM</th>
          </tr>
          </thead>

          <tbody class="divide-y divide-gray-700">
          <tr
            *ngFor="let row of summaryRows"
            [ngClass]="{
                'bg-orange-900': row.isClassTotal,
                'bg-orange-800': row.isClassRatio,
                'bg-blue-900'  : row.isGrandTotal,
                'font-semibold': row.isClassTotal,
                'italic'       : row.isClassRatio,
                'font-bold'    : row.isGrandTotal
              }"
          >
            <td class="px-6 py-4">{{ row.date }}</td>
            <td class="px-6 py-4">
              <ng-container *ngIf="!row.isGrandTotal">Class {{ row.classe }}</ng-container>
            </td>
            <td class="px-6 py-4">{{ row.categorieTitre }}</td>

            <!-- VC before -->
            <td class="px-6 py-4 text-right">
              <ng-container *ngIf="row.isClassRatio; else avVc">
                <span class="text-red-400 font-medium">{{ (row.ratioVc * 100) | number:'1.2-2' }}%</span>
              </ng-container>
              <ng-template #avVc>{{ row.vc | number:'1.2-2' }}</ng-template>
            </td>

            <!-- VM before -->
            <td class="px-6 py-4 text-right">
              <ng-container *ngIf="row.isClassRatio; else avVm">
                <span class="text-red-400 font-medium">{{ (row.ratioVm * 100) | number:'1.2-2' }}%</span>
              </ng-container>
              <ng-template #avVm>{{ row.vm | number:'1.2-2' }}</ng-template>
            </td>

            <!-- VC after -->
            <td class="px-6 py-4 text-right">
              <ng-container *ngIf="row.isClassRatio; else apVc">
                <span class="text-blue-400 font-medium">{{ (row.ratioApresVc! * 100) | number:'1.2-2' }}%</span>
              </ng-container>
              <ng-template #apVc>{{ row.apresVc | number:'1.2-2' }}</ng-template>
            </td>

            <!-- VM after -->
            <td class="px-6 py-4 text-right">
              <ng-container *ngIf="row.isClassRatio; else apVm">
                <span class="text-blue-400 font-medium">{{ (row.ratioApresVm! * 100) | number:'1.2-2' }}%</span>
              </ng-container>
              <ng-template #apVm>{{ row.apresVm | number:'1.2-2' }}</ng-template>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
