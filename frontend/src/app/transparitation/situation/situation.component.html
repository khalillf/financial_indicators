<!-- file: src/app/transparisation/situation/situation.component.html -->

<div class="p-4 bg-white rounded shadow">
  <h2 class="text-xl font-bold mb-4">Search Situation</h2>

  <!-- Inputs -->
  <div class="flex flex-col md:flex-row gap-4 mb-4">
    <input [(ngModel)]="ptf" type="text" placeholder="PTF" class="p-2 border rounded w-full md:w-1/3" />
    <input [(ngModel)]="dateImage" type="date" class="p-2 border rounded w-full md:w-1/3" />
    <input [(ngModel)]="dateImageFin" type="date" class="p-2 border rounded w-full md:w-1/3" />
  </div>

  <!-- Buttons -->
  <button (click)="goToTransparisation()" class="p-2 bg-blue-600 text-white rounded hover:bg-blue-700 mb-4">
    Go to Transparisation
  </button>

  <button (click)="fetchData()" class="p-2 bg-green-600 text-white rounded hover:bg-green-700 w-full md:w-auto mb-4">
    calculer avant traitement
  </button>

  <!-- "Transparise" button -->
  <div class="mt-4">
    <button (click)="transpariseData()" class="p-2 bg-purple-600 text-white rounded hover:bg-purple-700">
      Transparise
    </button>
  </div>

  <!-- Available dates -->
  <div *ngIf="availableDates.length > 0" class="mb-4">
    <div class="flex flex-wrap gap-2">
      <button
        *ngFor="let date of availableDates"
        (click)="selectDate(date)"
        [ngClass]="{
          'bg-blue-600 hover:bg-blue-700': date !== selectedDate,
          'bg-green-600': date === selectedDate
        }"
        class="px-4 py-2 rounded text-white"
      >
        {{ date }}
      </button>
    </div>
  </div>

  <!-- Title -->
  <div *ngIf="selectedDate" class="text-sm mb-2">
    Showing data for: <strong>{{ selectedDate }}</strong>
  </div>

  <!-- TABLE UNIQUE : Avant + Après -->
  <table class="min-w-full text-sm text-left border-collapse border border-gray-300" *ngIf="displayedData.length">
    <thead>
    <!-- Ligne 1 du header -->
    <tr class="bg-gray-100">
      <th class="border px-4 py-2" rowspan="2">Date</th>
      <th class="border px-4 py-2" rowspan="2">Classe</th>
      <th class="border px-4 py-2" rowspan="2">Catégorie</th>
      <th class="border px-4 py-2" colspan="2">Avant retraitement</th>
      <th class="border px-4 py-2" colspan="2">Après retraitement</th>
    </tr>
    <!-- Ligne 2 du header -->
    <tr class="bg-gray-100">
      <th class="border px-4 py-2">VC</th>
      <th class="border px-4 py-2">VM</th>
      <th class="border px-4 py-2">VC</th>
      <th class="border px-4 py-2">VM</th>
    </tr>
    </thead>
    <tbody>
    <tr
      *ngFor="let row of displayedData"
      [ngClass]="{
          'bg-orange-100 font-semibold': row.isClassTotal,
          'bg-orange-50 italic': row.isClassRatio,
          'bg-blue-100 font-bold': row.isGrandTotal
        }"
    >
      <!-- 1) Date -->
      <td class="border px-4 py-2">
        {{ row.date }}
      </td>

      <!-- 2) Classe -->
      <td class="border px-4 py-2">
        <ng-container *ngIf="!row.isGrandTotal">
          Classe {{ row.classe }}
        </ng-container>
      </td>

      <!-- 3) Catégorie -->
      <td class="border px-4 py-2">
        {{ row.categorieTitre }}
      </td>

      <!-- 4) VC (avant) -->
      <td class="border px-4 py-2">
        <ng-container *ngIf="row.isClassRatio; else normalVc">
            <span style="color: red;">
              {{ (row.ratioVc * 100) | number:'1.2-2' }}%
            </span>
        </ng-container>
        <ng-template #normalVc>
          {{ row.vc | number:'1.2-2' }}
        </ng-template>
      </td>

      <!-- 5) VM (avant) -->
      <td class="border px-4 py-2">
        <ng-container *ngIf="row.isClassRatio; else normalVm">
            <span style="color: red;">
              {{ (row.ratioVm * 100) | number:'1.2-2' }}%
            </span>
        </ng-container>
        <ng-template #normalVm>
          {{ row.vm | number:'1.2-2' }}
        </ng-template>
      </td>

      <!-- 6) VC (après) -->
      <td class="border px-4 py-2">
        {{ row.apresVc || 0 | number:'1.2-2' }}
      </td>

      <!-- 7) VM (après) -->
      <td class="border px-4 py-2">
        {{ row.apresVm || 0 | number:'1.2-2' }}
      </td>
    </tr>
    </tbody>
  </table>

  <div *ngIf="selectedDate && !displayedData.length">
    <p class="text-gray-500">No data available for {{ selectedDate }}</p>
  </div>

  <!--
       2e tableau affichant this.transpariseResults
       (à garder ou supprimer selon vos besoins)
  -->

</div>
